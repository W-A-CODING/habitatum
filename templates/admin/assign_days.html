{% extends 'admin_base.html' %}

{% block title %}Asignar D√≠as - {{ nombre_mes }} {{ anio_actual }} - Panel Admin{% endblock %}

{% block page_title %}
    Asignar D√≠as para Citas {% if tipo_cita == 'normal' %}Normales{% else %}Prioritarias{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* Estilos anteriores m√°s nuevos estilos */
    .assign-header {
        background-color: var(--blanco);
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .assign-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .assign-type-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .assign-type-badge.normal {
        background-color: var(--azul-medio);
        color: var(--azul-oscuro);
    }
    
    .assign-type-badge.prioritaria {
        background-color: var(--naranja);
        color: var(--blanco);
    }
    
    .calendar-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--blanco);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .nav-button {
        background-color: var(--azul-claro);
        color: var(--blanco);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: background-color 0.3s ease;
    }
    
    .nav-button:hover {
        background-color: var(--azul-oscuro);
    }
    
    .capacity-control {
        background-color: var(--beige);
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    
    .capacity-control h4 {
        color: var(--azul-oscuro);
        margin-bottom: 1rem;
        font-size: 1rem;
    }
    
    .capacity-input-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .capacity-input-group label {
        color: var(--azul-oscuro);
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .capacity-input-group input {
        width: 100px;
        padding: 0.5rem;
        border: 2px solid var(--azul-medio);
        border-radius: 4px;
        font-size: 1rem;
        text-align: center;
    }
    
    .calendar-container {
        background-color: var(--blanco);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .calendar-days-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .day-header {
        text-align: center;
        font-weight: 600;
        color: var(--azul-oscuro);
        padding: 0.75rem;
        font-size: 0.875rem;
    }
    
    .calendar-days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
    }
    
    .calendar-day-cell {
        aspect-ratio: 1;
        border: 2px solid var(--beige);
        border-radius: 8px;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: var(--blanco);
    }
    
    .calendar-day-cell:hover:not(.disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: var(--azul-claro);
    }
    
    .calendar-day-cell.disabled {
        background-color: var(--gris-claro);
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    .calendar-day-cell.selected {
        background-color: #d4edda;
        border-color: #28a745;
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
    }
    
    .calendar-day-cell.has-appointments {
        background-color: #fff3cd;
        border-color: #ffc107;
    }
    
    .calendar-day-cell.selected.has-appointments {
        background: linear-gradient(135deg, #d4edda 0%, #fff3cd 100%);
    }
    
    /* Checkbox oculto pero funcional */
    .day-checkbox {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }
    
    /* Indicador visual de checkbox */
    .day-checkbox-indicator {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 20px;
        height: 20px;
        border: 2px solid var(--azul-medio);
        border-radius: 4px;
        background-color: var(--blanco);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .day-checkbox:checked ~ .day-checkbox-indicator {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .day-checkbox:checked ~ .day-checkbox-indicator::after {
        content: '‚úì';
        color: var(--blanco);
        font-weight: bold;
    }
    
    .day-number {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--azul-oscuro);
        margin-bottom: 0.25rem;
    }
    
    .day-info {
        font-size: 0.65rem;
        color: var(--gris-medio);
        text-align: center;
    }
    
    .appointments-count {
        display: inline-block;
        background-color: var(--naranja);
        color: var(--blanco);
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.25rem;
    }
    
    .capacity-badge {
        display: inline-block;
        background-color: var(--azul-claro);
        color: var(--blanco);
        padding: 0.2rem 0.4rem;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-top: 0.25rem;
    }
    
    .capacity-badge.full {
        background-color: #dc3545;
    }
    
    .legend {
        background-color: var(--beige);
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    
    .legend h4 {
        color: var(--azul-oscuro);
        margin-bottom: 1rem;
        font-size: 1rem;
    }
    
    .legend-items {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .legend-box {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        border: 2px solid;
    }
    
    .legend-box.normal {
        background-color: var(--blanco);
        border-color: var(--beige);
    }
    
    .legend-box.selected {
        background-color: #d4edda;
        border-color: #28a745;
    }
    
    .legend-box.with-appointments {
        background-color: #fff3cd;
        border-color: #ffc107;
    }
    
    .legend-box.disabled {
        background-color: var(--gris-claro);
        border-color: var(--beige);
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .bulk-actions {
        background-color: var(--beige);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-bulk {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
    
    @media (max-width: 768px) {
        .calendar-navigation {
            flex-direction: column;
            gap: 1rem;
        }
        
        .calendar-days-grid {
            gap: 0.25rem;
        }
        
        .calendar-day-cell {
            padding: 0.5rem;
        }
        
        .day-number {
            font-size: 1rem;
        }
        
        .legend-items {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .bulk-actions {
            flex-direction: column;
        }
        
        .capacity-input-group {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="assign-header">
    <div class="assign-header-top">
        <h3 style="color: var(--azul-oscuro); font-size: 1.5rem;">
            Gestionar Disponibilidad de D√≠as
        </h3>
        <span class="assign-type-badge {{ tipo_cita }}">
            {% if tipo_cita == 'normal' %}
            üìÖ Citas Normales
            {% else %}
            üíº Citas Prioritarias
            {% endif %}
        </span>
    </div>
    <p style="color: var(--gris-medio);">
        {% if tipo_cita == 'normal' %}
        Selecciona los d√≠as disponibles para citas normales. Marca las casillas de los d√≠as en que deseas aceptar citas.
        {% else %}
        Selecciona los d√≠as disponibles para citas prioritarias con asesor√≠a crediticia. Marca las casillas de los d√≠as espec√≠ficos.
        {% endif %}
    </p>
</div>

<!-- Navegaci√≥n del Calendario -->
<div class="calendar-navigation">
    <a href="?mes={{ mes_anterior }}&anio={{ anio_anterior }}" class="nav-button">‚Üê Mes Anterior</a>
    <h3 style="color: var(--azul-oscuro); font-size: 1.5rem; font-weight: 700;">{{ nombre_mes }} {{ anio_actual }}</h3>
    <a href="?mes={{ mes_siguiente }}&anio={{ anio_siguiente }}" class="nav-button">Mes Siguiente ‚Üí</a>
</div>

<form method="post" id="assignDaysForm">
    {% csrf_token %}
    
    <!-- Control de Capacidad -->
    <div class="capacity-control">
        <h4>‚öôÔ∏è Configuraci√≥n de Capacidad</h4>
        <div class="capacity-input-group">
            <label for="capacidad_maxima">M√°ximo de citas por d√≠a:</label>
            <input type="number" id="capacidad_maxima" name="capacidad_maxima" 
                   min="1" max="20" value="{{ capacidad_actual }}" required>
            <span style="color: var(--gris-medio); font-size: 0.875rem;">
                Esta capacidad se aplicar√° a todos los d√≠as seleccionados
            </span>
        </div>
    </div>
    
    <!-- Acciones Masivas -->
    <div class="bulk-actions">
        <button type="button" class="btn btn-secondary btn-bulk" onclick="seleccionarTodos()">
            ‚úì Seleccionar Todos
        </button>
        <button type="button" class="btn btn-secondary btn-bulk" onclick="deseleccionarTodos()">
            ‚úó Deseleccionar Todos
        </button>
        <button type="button" class="btn btn-secondary btn-bulk" onclick="seleccionarDiasSemana()">
            üìÖ Solo D√≠as de Semana
        </button>
    </div>
    
    <!-- Calendario -->
    <div class="calendar-container">
        <!-- Headers de d√≠as -->
        <div class="calendar-days-header">
            <div class="day-header">Lun</div>
            <div class="day-header">Mar</div>
            <div class="day-header">Mi√©</div>
            <div class="day-header">Jue</div>
            <div class="day-header">Vie</div>
            <div class="day-header">S√°b</div>
            <div class="day-header">Dom</div>
        </div>
        
        <!-- Grid de d√≠as -->
        <div class="calendar-days-grid">
            {% for dia in dias_del_mes %}
            <label class="calendar-day-cell 
                {% if dia.es_pasado %}disabled{% endif %}
                {% if dia.esta_disponible %}selected{% endif %}
                {% if dia.citas > 0 %}has-appointments{% endif %}"
                {% if dia.es_pasado %}style="pointer-events: none;"{% endif %}>
                
                <input type="checkbox" 
                       class="day-checkbox" 
                       name="dias_disponibles" 
                       value="{{ dia.numero }}"
                       {% if dia.esta_disponible %}checked{% endif %}
                       {% if dia.es_pasado %}disabled{% endif %}
                       data-dia="{{ dia.numero }}"
                       data-weekday="{{ dia.nombre_dia }}">
                
                <span class="day-checkbox-indicator"></span>
                
                <span class="day-number">{{ dia.numero }}</span>
                <span class="day-info">{{ dia.nombre_dia }}</span>
                
                {% if dia.citas > 0 %}
                <span class="appointments-count">
                    {{ dia.citas }} cita{{ dia.citas|pluralize }}
                </span>
                {% endif %}
                
                {% if dia.capacidad_info %}
                <span class="capacity-badge {% if not dia.capacidad_info.esta_disponible %}full{% endif %}">
                    {{ dia.capacidad_info.capacidad_disponible }}/{{ dia.capacidad_info.capacidad_maxima }}
                </span>
                {% endif %}
            </label>
            {% endfor %}
        </div>
    </div>
    
    <!-- Leyenda -->
    <div class="legend">
        <h4>üìã Leyenda</h4>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-box normal"></div>
                <span style="color: var(--gris-medio); font-size: 0.875rem;">D√≠a no disponible</span>
            </div>
            <div class="legend-item">
                <div class="legend-box selected"></div>
                <span style="color: var(--gris-medio); font-size: 0.875rem;">D√≠a disponible (seleccionado)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box with-appointments"></div>
                <span style="color: var(--gris-medio); font-size: 0.875rem;">D√≠a con citas agendadas</span>
            </div>
            <div class="legend-item">
                <div class="legend-box disabled"></div>
                <span style="color: var(--gris-medio); font-size: 0.875rem;">D√≠a pasado (no editable)</span>
            </div>
        </div>
    </div>
    
    <!-- Botones de Acci√≥n -->
    <div class="action-buttons">
        <button type="submit" class="btn btn-success">
            üíæ Guardar Cambios
        </button>
        <a href="{% url 'dashboard:assign_days' %}" class="btn btn-secondary">
            ‚Üê Volver al Men√∫
        </a>
    </div>
</form>

<script>
// Funci√≥n para seleccionar todos los d√≠as disponibles
function seleccionarTodos() {
    const checkboxes = document.querySelectorAll('.day-checkbox:not([disabled])');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        checkbox.closest('.calendar-day-cell').classList.add('selected');
    });
}

// Funci√≥n para deseleccionar todos los d√≠as
function deseleccionarTodos() {
    const checkboxes = document.querySelectorAll('.day-checkbox:not([disabled])');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.closest('.calendar-day-cell').classList.remove('selected');
    });
}

// Funci√≥n para seleccionar solo d√≠as de semana (Lun-Vie)
function seleccionarDiasSemana() {
    const checkboxes = document.querySelectorAll('.day-checkbox:not([disabled])');
    checkboxes.forEach(checkbox => {
        const weekday = checkbox.getAttribute('data-weekday');
        if (weekday !== 'S√°b' && weekday !== 'Dom') {
            checkbox.checked = true;
            checkbox.closest('.calendar-day-cell').classList.add('selected');
        } else {
            checkbox.checked = false;
            checkbox.closest('.calendar-day-cell').classList.remove('selected');
        }
    });
}

// Actualizar visual al hacer click en checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.day-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const cell = this.closest('.calendar-day-cell');
            if (this.checked) {
                cell.classList.add('selected');
            } else {
                cell.classList.remove('selected');
            }
        });
    });
    
    // Confirmaci√≥n antes de enviar
    const form = document.getElementById('assignDaysForm');
    form.addEventListener('submit', function(e) {
        const selectedDays = document.querySelectorAll('.day-checkbox:checked').length;
        const capacity = document.getElementById('capacidad_maxima').value;
        
        if (selectedDays === 0) {
            e.preventDefault();
            alert('‚ö†Ô∏è No has seleccionado ning√∫n d√≠a. Por favor selecciona al menos un d√≠a disponible.');
            return false;
        }
        
        const confirmMessage = `¬øConfirmar cambios?\n\n` +
            `üìÖ D√≠as seleccionados: ${selectedDays}\n` +
            `üë• Capacidad por d√≠a: ${capacity} cita(s)\n\n` +
            `Esto actualizar√° la disponibilidad para {{ nombre_mes }} {{ anio_actual }}.`;
        
        if (!confirm(confirmMessage)) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}